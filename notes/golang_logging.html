<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Golang заметки - Журналирование</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="../static/favicon.ico">
<link rel="stylesheet" href="../static/org.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">Golang заметки - Журналирование</h1>
<p>
Простейшее использование пакета log. Сообщения пишутся в <b>os.Stderr</b>:
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="org-keyword">package</span> main

<span class="org-keyword">import</span> (
        <span class="org-string">"log"</span>
)

<span class="org-keyword">func</span> <span class="org-function-name">main</span>() {
        log.<span class="org-function-name">Println</span>(<span class="org-string">"Test message"</span>)
        log.<span class="org-function-name">Fatal</span>(<span class="org-string">"Fatal message"</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">&#1073;&#1091;&#1076;&#1077;&#1090; &#1074;&#1099;&#1093;&#1086;&#1076; &#1089; &#1082;&#1086;&#1076;&#1086;&#1084; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080;</span>
}
</pre>
</div>

<p>
Журналирование с использование <b>log.Logger</b>, он поддерживает функции передачи данных любому объекту io.Writer, способен работать с файлами и сетевыми подключениями:
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="org-keyword">package</span> main

<span class="org-keyword">import</span> (
        <span class="org-string">"log"</span>
        <span class="org-string">"os"</span>
)

<span class="org-keyword">func</span> <span class="org-function-name">main</span>() {
        <span class="org-variable-name">logfile</span>, <span class="org-variable-name">_</span> := os.<span class="org-function-name">Create</span>(<span class="org-string">"./test.log"</span>)
        <span class="org-keyword">defer</span> logfile.<span class="org-function-name">Close</span>()
        <span class="org-variable-name">logger</span> := log.<span class="org-function-name">New</span>(logfile, <span class="org-string">"Prefix "</span>, log.LstdFlags|log.Llongfile)
        logger.<span class="org-function-name">Println</span>(<span class="org-string">"Test message"</span>)
        logger.<span class="org-function-name">Fataln</span>(<span class="org-string">"Fatal message"</span>)
}
</pre>
</div>


<div id="org4351d0c" class="figure">
<p><img src="../static/golang_logging.png" alt="golang_logging.png" width="500" />
</p>
</div>

<p>
Пример простого журналирования с записью в сетевой сокет:
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="org-keyword">package</span> main

<span class="org-keyword">import</span> (
        <span class="org-string">"log"</span>
        <span class="org-string">"net"</span>
)

<span class="org-keyword">func</span> <span class="org-function-name">main</span>() {
        <span class="org-variable-name">conn</span>, <span class="org-variable-name">err</span> := net.<span class="org-function-name">Dial</span>(<span class="org-string">"tcp"</span>, <span class="org-string">"localhost:8080"</span>)

        <span class="org-keyword">if</span> err != <span class="org-constant">nil</span> {
                <span class="org-builtin">panic</span>(<span class="org-string">"Failed to connect to localhost:8080"</span>)
        }
        <span class="org-keyword">defer</span> conn.<span class="org-function-name">Close</span>()

        <span class="org-variable-name">logger</span> := log.<span class="org-function-name">New</span>(conn, <span class="org-string">"log: "</span>, log.LstdFlags|log.Llongfile)
        logger.<span class="org-function-name">Println</span>(<span class="org-string">"Test log message"</span>)
}
</pre>
</div>

<p>
Запись сообщений в системный журнал, с помощью <b>log/syslog</b>:
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="org-keyword">package</span> main

<span class="org-keyword">import</span> (
        <span class="org-string">"fmt"</span>
        <span class="org-string">"log"</span>
        <span class="org-string">"log/syslog"</span>
)

<span class="org-keyword">func</span> <span class="org-function-name">main</span>() {
        <span class="org-variable-name">priority</span> := syslog.LOG_LOCAL3 | syslog.LOG_NOTICE
        <span class="org-variable-name">flags</span> := log.Ldate | log.Lshortfile

        <span class="org-variable-name">logger</span>, <span class="org-variable-name">err</span> := syslog.<span class="org-function-name">NewLogger</span>(priority, flags)
        <span class="org-keyword">if</span> err != <span class="org-constant">nil</span> {
                fmt.<span class="org-function-name">Printf</span>(<span class="org-string">"Can't attach to syslog: %s"</span>, err)
                <span class="org-keyword">return</span>
        }

        logger.<span class="org-function-name">Println</span>(<span class="org-string">"This is a test log message."</span>)
}

<span class="org-comment-delimiter">// </span><span class="org-comment">&#1080;&#1102;&#1085; 19 00:55:52 kiky-aspire /tmp/go-build002934745/b001/exe/main[12988]: 2020/06/19 main.go:17: This is a test log message.</span>
</pre>
</div>

<p>
Динамическое определение вида и уровня серьезности, при записи в системный журнал:
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="org-keyword">package</span> main

<span class="org-keyword">import</span> (
        <span class="org-string">"log/syslog"</span>
)

<span class="org-keyword">func</span> <span class="org-function-name">main</span>() {
        <span class="org-variable-name">logger</span>, <span class="org-variable-name">err</span> := syslog.<span class="org-function-name">New</span>(syslog.LOG_LOCAL3, <span class="org-string">"kiky"</span>)
        <span class="org-keyword">if</span> err != <span class="org-constant">nil</span> {
                <span class="org-builtin">panic</span>(<span class="org-string">"Cannot attach to syslog"</span>)
        }
        <span class="org-keyword">defer</span> logger.<span class="org-function-name">Close</span>()

        logger.<span class="org-function-name">Debug</span>(<span class="org-string">"Debug message."</span>)
        logger.<span class="org-function-name">Notice</span>(<span class="org-string">"Notice message."</span>)
        logger.<span class="org-function-name">Warning</span>(<span class="org-string">"Warning message."</span>)
        logger.<span class="org-function-name">Alert</span>(<span class="org-string">"Alert message."</span>)
}
</pre>
</div>

<p>
Вывод трассировки стека в поток стандратного вывода:
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="org-keyword">package</span> main

<span class="org-keyword">import</span> <span class="org-string">"runtime/debug"</span>

<span class="org-keyword">func</span> <span class="org-function-name">foo</span>() {
        <span class="org-function-name">bar</span>()
}

<span class="org-keyword">func</span> <span class="org-function-name">bar</span>() {
        debug.<span class="org-function-name">PrintStack</span>()
}

<span class="org-keyword">func</span> <span class="org-function-name">main</span>() {
        <span class="org-function-name">foo</span>()
}

<span class="org-comment-delimiter">// </span><span class="org-comment">&#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;:</span>
<span class="org-comment-delimiter">/*</span>
<span class="org-comment">[kiky@kiky-aspire main]$ go run main.go</span>
<span class="org-comment">goroutine 1 [running]:</span>
<span class="org-comment">runtime/debug.Stack(0xc000034778, 0xc00006af78, 0x40461f)</span>
<span class="org-comment">/usr/lib/go/src/runtime/debug/stack.go:24 +0x9d</span>
<span class="org-comment">runtime/debug.PrintStack()</span>
<span class="org-comment">/usr/lib/go/src/runtime/debug/stack.go:16 +0x22</span>
<span class="org-comment">main.bar(...)</span>
<span class="org-comment">/home/kiky/go/src/main/main.go:10</span>
<span class="org-comment">main.foo(...)</span>
<span class="org-comment">/home/kiky/go/src/main/main.go:6</span>
<span class="org-comment">main.main()</span>
<span class="org-comment">/home/kiky/go/src/main/main.go:14 +0x21</span>
<span class="org-comment">*/</span>
</pre>
</div>
</div>
<div id="postamble" class="status">
<p class="creator">Made with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 28.2 (<a href="https://orgmode.org/">Org</a> mode 9.5.5)</p>
</div>
</body>
</html>
