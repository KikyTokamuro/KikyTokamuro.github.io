<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Смотрим картинки с Reddit в Emacs</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="../static/favicon.ico">
<link rel="stylesheet" href="../static/org.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">Смотрим картинки с Reddit в Emacs</h1>
<blockquote>
<p>
Дело было вечером,
Делать было нечего&#x2026;<br />
   &#x2014; Сергей Михалков
</p>
</blockquote>

<p>
Думаю не секрет, что я являюсь пользователем <del>операционной системы</del> текстового редактора <a href="https://www.gnu.org/software/emacs/">Emacs</a>. Но при этом, я никогда не писал что-то свое с использованием <b>Emacs Lisp</b>, максимум, что делал, так это вносил различные изменения в свой <b>.emacs.d</b> для конфигурирования самого редактора.
</p>

<p>
Так как я уже использую <b>Emacs</b> для чтения <a href="https://github.com/skeeto/elfeed">RSS</a> и <a href="https://github.com/emacsmirror/elpher">Gemini</a>, почему бы еще не просматривать свежие картинки с <a href="https://www.reddit.com/">Reddit</a> через него, подумал я.
</p>

<p>
Знакомимся с материалами по языку и в "бой":
</p>
<ul class="org-ul">
<li><a href="https://www.gnu.org/software/emacs/manual/html_node/eintr/">https://www.gnu.org/software/emacs/manual/html_node/eintr/</a></li>
<li><a href="https://emacsdocs.org/docs/elisp/Emacs-Lisp">https://emacsdocs.org/docs/elisp/Emacs-Lisp</a></li>
</ul>

<p>
Первым делом нам надо подключить пакеты <b>json</b> и <b>url</b>, для того, чтобы можно было получать данные с URL и парсить JSON формат.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">json</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">url</span>)
</pre>
</div>

<p>
Далее весь код умещается в пять функций, рассмотрим каждую из них.
</p>

<p>
Функция <b>my/insert-image-from-url</b> предназначена для того чтобы получить изображение с URL адреса, и вставить его в текущий буфер.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/insert-image-from-url</span> (url)
  <span class="org-doc">"Insert image from URL."</span>
  (<span class="org-keyword">let</span> ((buffer (url-retrieve-synchronously url)))
    (<span class="org-keyword">unwind-protect</span>
        (<span class="org-keyword">let</span> ((data (<span class="org-keyword">with-current-buffer</span> buffer
                      (goto-char (point-min))
                      (search-forward <span class="org-string">"\n\n"</span>)
                      (buffer-substring (point) (point-max)))))
          (insert-image (create-image data nil t <span class="org-builtin">:width</span> 200)))
      (kill-buffer buffer))))
</pre>
</div>
<p>
В коде функции <b>unwind-protect</b> используется для гарантированного выполнения некоторых действий, даже если возникает ошибка или исключение. В данном случае, если возникает ошибка при получении данных изображения с URL <b>unwind-protect</b> гарантирует, что буфер, в котором происходит манипуляция изображением, будет убит с помощью <b>kill-buffer</b>. Таким образом, <b>unwind-protect</b> позволяет избежать утечек памяти и других проблем, которые могут возникнуть при непредвиденных ситуациях.
</p>

<p>
Функция <b>my/get-response-from-url</b> предназначена для получения данных с URL и возврата их ввиде строки. Используется, чтобы получить данные от Reddit API.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-response-from-url</span> (url)
  <span class="org-doc">"Get data from URL."</span>
  (<span class="org-keyword">let</span> ((buffer (url-retrieve-synchronously url)))
    (<span class="org-keyword">with-current-buffer</span> buffer
      (<span class="org-keyword">unwind-protect</span>
          (<span class="org-keyword">progn</span>
            (goto-char (point-min))
            (re-search-forward <span class="org-string">"^$"</span>)
            (buffer-substring-no-properties (point) (point-max)))
        (kill-buffer buffer)))))
</pre>
</div>

<p>
Функция <b>my/normal-image-url-p</b> предназначена для проверки, является ли URL допустимым для использования в качестве изображения.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/normal-image-url-p</span> (url)
  <span class="org-doc">"Check image URL."</span>
  (<span class="org-keyword">and</span> (not (string-match-p <span class="org-string">"redgifs"</span> url))
       (<span class="org-keyword">or</span> (string-suffix-p <span class="org-string">".png"</span> url)
           (string-suffix-p <span class="org-string">".gif"</span> url)
           (string-suffix-p <span class="org-string">".jpg"</span> url)
           (string-suffix-p <span class="org-string">".jpeg"</span> url))))
</pre>
</div>

<p>
Функция <b>my/get-new-images-from-subreddit</b> предназначена для получения списка новых постов с изображениями с указанного subreddit. Результирующий список будет содержать информацию о каждом изображении, включая заголовок поста, ссылку на изображения и ссылку на сам пост.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/get-new-images-from-subreddit</span> (sub)
  <span class="org-doc">"Get list of SUB new images."</span>
  (<span class="org-keyword">let*</span> ((reddit-url <span class="org-string">"https://www.reddit.com"</span>)
         (url (concat reddit-url <span class="org-string">"/r/"</span> sub <span class="org-string">"/new.json"</span>))
         (json-str (my/get-response-from-url url))
         (json-object (json-read-from-string json-str)))
    (remq nil (mapcar
               (<span class="org-keyword">lambda</span> (child)
                 (<span class="org-keyword">let*</span> ((data (cdr (assoc 'data child)))
                        (image-url (cdr (assoc 'url_overridden_by_dest data))))
                   (<span class="org-keyword">when</span> (my/normal-image-url-p image-url)
                     `((title . ,(cdr (assoc 'title data)))
                       (image . ,image-url)
                       (post . ,(concat reddit-url (cdr (assoc 'permalink data))))))))
               (cdr (assoc 'children (cdr (assoc 'data json-object))))))))
</pre>
</div>

<p>
И последняя функция <b>my/show-reddit-images</b> предназначена для открытия нового буфера с интересующими нас картинками. Она является интерактивной, что позволяет нам вызвать ее с помощью <b>M-x</b> и передать интересующий нас subreddit.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my/show-reddit-images</span> (sub)
  <span class="org-doc">"Show new image from SUB."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"sEnter subreddit: "</span>)
  (<span class="org-keyword">let</span> ((buffer (generate-new-buffer (format <span class="org-string">"*Images [%s]*"</span> sub))))
    (<span class="org-keyword">with-current-buffer</span> buffer
      (erase-buffer)
      (<span class="org-keyword">dolist</span> (item (my/get-new-images-from-subreddit sub))
        (<span class="org-keyword">dolist</span> (key '(title post image))
          (insert (concat
                   (propertize (capitalize (symbol-name key)) 'face 'bold)
                   <span class="org-string">": "</span>
                   (cdr (assoc key item))
                   <span class="org-string">"\n"</span>)))
        (my/insert-image-from-url (cdr (assoc 'image item)))
        (insert <span class="org-string">"\n\n"</span>)))
    (switch-to-buffer buffer)))
</pre>
</div>

<p>
Итоговый результат работы всего этого в совокупности выглядит <a href="https://github.com/KikyTokamuro/dotfiles/blob/master/.emacs.d/elisp/reddit-images.el">так</a>:
</p>

<div id="org31abd44" class="figure">
<p><img src="../static/reddit_images.png" alt="reddit_images.png" width="700" />
</p>
</div>
</div>
<div id="postamble" class="status">
<p class="creator">Made with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.3 (<a href="https://orgmode.org/">Org</a> mode 9.6.15)</p>
</div>
</body>
</html>
